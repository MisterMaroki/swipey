# Auto-Updates via Sparkle 2

## Context

Swipey is distributed as a code-signed, notarized DMG via a static site. Users currently have no way to know about or install updates without manually re-downloading. This design adds automatic update checking and installation using Sparkle 2.

## Decisions

- **Framework**: Sparkle 2.8.1 (industry-standard macOS updater, EdDSA signature verification, delta updates)
- **Update source**: Static site hosts `appcast.xml` alongside DMGs
- **UX**: Silent background check + download, then prompt user to install

## Architecture

### App side (runtime)

- **`UpdateController.swift`** — thin wrapper around `SPUStandardUpdaterController`. Initializes on launch with `startingUpdater: true` for automatic background checks (default: every 24h).
- **`AppDelegate`** — creates `UpdateController` in `applicationDidFinishLaunching`.
- **`StatusBarController`** — gains a "Check for Updates..." menu item wired to `updateController.checkForUpdates()`.

### Build/release side

- **EdDSA keypair** — generated once via Sparkle's `generate_keys`, stored in Keychain. Public key embedded in Info.plist.
- **Appcast** — `site/appcast.xml`, hosted at `https://swipey-alpha.vercel.app/appcast.xml`, generated by Sparkle's `generate_appcast` tool during the build process.
- **`build-app.sh`** — copies `Sparkle.framework` into `.app/Contents/Frameworks/`, code-signs it, adds `SUFeedURL` and `SUPublicEDKey` to Info.plist, runs `generate_appcast` after DMG creation.

### Data flow

```
App launch -> SPUUpdater starts background timer
Timer fires -> GET site/appcast.xml
Parse appcast -> compare version to CFBundleShortVersionString
New version found -> download DMG silently
Download complete -> prompt user "Update available, install now?"
User accepts -> Sparkle extracts, replaces app, relaunches
```

## Detailed Changes

### Package.swift

- Add dependency: `.package(url: "https://github.com/sparkle-project/Sparkle", from: "2.8.1")`
- Add `"Sparkle"` to `SwipeyLib` target dependencies
- Add linker setting: `.unsafeFlags(["-Wl,-rpath,@loader_path/../Frameworks"])`

### New: `Sources/Swipey/UpdateController.swift`

- `@MainActor final class UpdateController`
- Owns `SPUStandardUpdaterController`
- `init()` creates controller with `startingUpdater: true`
- `checkForUpdates()` calls through to Sparkle
- `canCheckForUpdates` for menu item validation

### Modified: `AppDelegate.swift`

- Create `UpdateController` in `applicationDidFinishLaunching`
- Pass to `StatusBarController`

### Modified: `StatusBarController.swift`

- Accept `UpdateController` in init
- Add "Check for Updates..." menu item

### Modified: `build-app.sh`

- Copy `Sparkle.framework` from SPM build artifacts to `Contents/Frameworks/`
- Code-sign the framework
- Add `SUFeedURL` and `SUPublicEDKey` to Info.plist
- Run `generate_appcast` against `site/` after DMG creation

### Entitlements

No changes needed — app is not sandboxed, so network access works without additional entitlements.

## One-Time Setup Instructions

### 1. Generate EdDSA signing keys

Find the `generate_keys` tool in Sparkle's artifacts:

```bash
GENERATE_KEYS=$(find .build/artifacts -name "generate_keys" -type f | head -1)
"$GENERATE_KEYS"
```

This creates a private key in your Keychain and prints the public key. Copy the public key.

### 2. Set the public key

Either:
- Export as env var: `export SPARKLE_ED_KEY="your-base64-public-key"`
- Or replace the placeholder in `build-app.sh` directly

### 3. First release with Sparkle

Run `./build-app.sh` as normal. The script will:
1. Embed Sparkle.framework in the app bundle
2. Add SUFeedURL and SUPublicEDKey to Info.plist
3. After creating the DMG, generate `site/appcast.xml`

### 4. Deploy

Upload the updated `site/` directory (including `appcast.xml` and the new DMG) to your static site host.
